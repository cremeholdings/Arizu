"use strict";exports.id=270,exports.ids=[270],exports.modules={91180:(e,t,r)=>{r.d(t,{m:()=>a,q:()=>d});let n={nodeWidth:240,nodeHeight:100,horizontalSpacing:300,verticalSpacing:150,startX:100,startY:100};class a extends Error{constructor(e,t,r){super(t),this.code=e,this.step=r,this.name="CompilerError"}}async function s(e,t){return console.log(`TODO: Resolve action definition "${e}" for org ${t.slice(0,8)}...`),null}function o(e){return e.replace(/[^a-zA-Z0-9_]/g,"_").substring(0,50)}function i(e){return e.replace(/\{\{([^}]+)\}\}/g,(e,t)=>{let r=t.trim();if(r.startsWith("secrets.")){let e=r.replace("secrets.","");return`{{ $vars.${e} }}`}return`{{ $json.${r} }}`})}function l(e){let t=`{{ $json.${e.field} }}`;switch(e.op){case"equals":return{value1:t,operation:"equal",value2:e.value};case"contains":return{value1:t,operation:"contains",value2:e.value};case"gt":return{value1:t,operation:"larger",value2:e.value};case"lt":return{value1:t,operation:"smaller",value2:e.value};case"regex":return{value1:t,operation:"regex",value2:e.value};default:throw new a("UNSUPPORTED_FILTER_OPERATION",`Unsupported filter operation "${e.op}". Supported operations: equals, contains, gt, lt, regex`)}}async function c(e,t,r){let n=await s(e.actionSlug,r);if(!n)throw new a("UNKNOWN_CUSTOM_ACTION",`Custom action "${e.actionSlug}" is not available for your organization. Check the spelling or contact support to add this action.`,e);return{id:t,name:o(`Custom_${e.actionSlug}`),type:"n8n-nodes-base.httpRequest",typeVersion:4,position:[0,0],parameters:{method:n.method.toUpperCase(),url:n.url,authentication:"none",options:{response:{fullResponse:!1},...n.headers&&{headers:Object.entries(n.headers).map(([e,t])=>({name:e,value:"string"==typeof t?i(t):t}))},...n.body&&{bodyContentType:"json",jsonBody:JSON.stringify({...n.body,...e.input},null,2)}}}}}async function p(e,t,r){switch(e.type){case"trigger.http":return{id:t,name:o(`Webhook_${e.path.replace(/[^a-zA-Z0-9]/g,"_")}`),type:"n8n-nodes-base.webhook",typeVersion:1,position:[0,0],parameters:{path:e.path,httpMethod:"POST",responseMode:"responseNode",options:{noResponseBody:!1,...e.secretHmac&&{authentication:"headerAuth",headerAuth:{name:"X-Hub-Signature-256",value:"={{ $vars.webhook_secret }}"}}}},webhookId:`webhook_${Math.random().toString(36).substring(2,15)}`};case"filter":return function(e,t){let r=l(e.when);return{id:t,name:o(`Filter_${e.when.field}`),type:"n8n-nodes-base.if",typeVersion:1,position:[0,0],parameters:{conditions:{string:[r]}}}}(e,t);case"branch":return function(e,t){let r=e.cases.map((e,t)=>({value:t.toString(),condition:l(e.when)}));return{id:t,name:o("Branch_Switch"),type:"n8n-nodes-base.switch",typeVersion:1,position:[0,0],parameters:{dataType:"string",value1:"={{ $json }}",rules:{values:r.map((e,t)=>({conditions:{string:[e.condition]},output:t}))},fallbackOutput:e.else?e.cases.length:-1}}}(e,t);case"action.slack.postMessage":return{id:t,name:o(`Slack_${e.channel.replace("#","").replace("@","")}`),type:"n8n-nodes-base.slack",typeVersion:1,position:[0,0],parameters:{operation:"postMessage",channel:e.channel,text:i(e.text),otherOptions:{},authentication:"oAuth2"}};case"action.http.request":return function(e,t){let r=new URL(e.url);return{id:t,name:o(`HTTP_${r.hostname.replace(/[^a-zA-Z0-9]/g,"_")}`),type:"n8n-nodes-base.httpRequest",typeVersion:4,position:[0,0],parameters:{method:e.method,url:e.url,authentication:"none",options:{response:{fullResponse:!1},...e.headers&&{headers:Object.entries(e.headers).map(([e,t])=>({name:e,value:"string"==typeof t?i(t):t}))},...e.body&&{bodyContentType:"json",jsonBody:JSON.stringify(e.body,null,2)}}}}}(e,t);case"custom.action":return await c(e,t,r);default:throw new a("UNSUPPORTED_STEP_TYPE",`Unsupported step type "${e.type}". Use custom.action for unsupported integrations.`,e)}}async function u(e,t,r,n){let a=[];for(let o of e){var s;let e=(s=r.count++,`node_${s.toString().padStart(3,"0")}`);if("branch"===o.type){n.set(e,{cases:o.cases.length,hasElse:!!o.else});let s=await p(o,e,t);for(let e of(a.push(s),o.cases)){let s=await u(e.steps,t,r,n);a.push(...s)}if(o.else){let e=await u(o.else,t,r,n);a.push(...e)}}else{let r=await p(o,e,t);a.push(r)}}return a}async function d(e,t){try{console.log("Compiling plan to n8n workflow",{planName:e.name,stepCount:e.steps.length,orgId:t.orgId.slice(0,8)+"..."});let r=new Map,s=await u(e.steps,t.orgId,{count:0},r);if(0===s.length)throw new a("NO_NODES_GENERATED","Plan compilation resulted in no nodes. Ensure the plan has valid steps.");let o=function(e,t){let r={};for(let n=0;n<e.length-1;n++){let a=e[n],s=e[n+1];r[a.id]||(r[a.id]={});let o=t.get(a.id);if("n8n-nodes-base.if"===a.type)r[a.id].main=[{source:a.id,sourceOutput:"main",target:s.id,targetInput:"main"},{source:a.id,sourceOutput:"main",target:s.id,targetInput:"main"}];else if("n8n-nodes-base.switch"===a.type&&o){let e=[];for(let t=0;t<o.cases;t++)e.push({source:a.id,sourceOutput:"main",target:s.id,targetInput:"main"});o.hasElse&&e.push({source:a.id,sourceOutput:"main",target:s.id,targetInput:"main"}),r[a.id].main=e}else r[a.id].main=[{source:a.id,sourceOutput:"main",target:s.id,targetInput:"main"}]}return r}(s,r),i=function(e,t,r={}){let a={...n,...r};if(0===e.length)return[];if(1===e.length)return[{...e[0],position:[a.startX,a.startY]}];try{let r=function(e,t){let r=new Map;return e.forEach(e=>{r.set(e.id,[])}),Object.entries(t).forEach(([e,t])=>{Object.values(t).forEach(t=>{t.forEach(t=>{let n=r.get(t.target)||[];n.includes(e)||(n.push(e),r.set(t.target,n))})})}),r}(e,t),n=function(e,t){let r=new Map,n=new Set;return e.forEach(e=>(function e(a){if(n.has(a))return r.get(a)||0;n.add(a);let s=t.get(a)||[];if(0===s.length)return r.set(a,0),0;let o=Math.max(...s.map(t=>e(t)))+1;return r.set(a,o),o})(e.id)),r}(e,r),s=function(e,t){let r=new Map;return e.forEach(e=>{let n=t.get(e.id)||0,a=r.get(n)||[];a.push(e),r.set(n,a)}),r}(e,n),o=function(e,t){let r=new Map;return e.forEach((e,n)=>{let a=t.startX+n*t.horizontalSpacing,s=e.sort((e,t)=>e.name.localeCompare(t.name));s.forEach((e,n)=>{let o=s.length*t.nodeHeight+(s.length-1)*t.verticalSpacing,i=t.startY-o/2+n*(t.nodeHeight+t.verticalSpacing);r.set(e.id,[a,i])})}),r}(s,a);return e.map(e=>({...e,position:o.get(e.id)||[a.startX,a.startY]}))}catch(t){return console.warn("Auto-layout failed, falling back to simple grid layout",{error:t instanceof Error?t.message:"Unknown error",nodeCount:e.length}),e.map((e,t)=>({...e,position:[a.startX+t%3*a.horizontalSpacing,a.startY+Math.floor(t/3)*a.verticalSpacing]}))}}(s,o),l={nodes:i,connections:o,name:e.name};return console.log("Plan compiled successfully",{planName:e.name,nodeCount:i.length,connectionCount:Object.keys(o).length,orgId:t.orgId.slice(0,8)+"..."}),{workflow:l,name:e.name}}catch(e){if(e instanceof a)throw console.error("Plan compilation failed",{code:e.code,message:e.message,stepType:e.step?.type,orgId:t.orgId.slice(0,8)+"..."}),e;throw console.error("Unexpected compilation error",{error:e instanceof Error?e.message:"Unknown error",orgId:t.orgId.slice(0,8)+"..."}),new a("COMPILATION_ERROR",`Failed to compile plan: ${e instanceof Error?e.message:"Unknown error"}`)}}},55227:(e,t,r)=>{r.d(t,{Iy:()=>g,V1:()=>u,dK:()=>d});var n=r(79984);class a{constructor(e){this.redisUrl=e,this.client=null,this.connecting=!1}async getClient(){if(this.client?.isOpen)return this.client;if(this.connecting)return await new Promise(e=>setTimeout(e,100)),this.getClient();try{this.connecting=!0;let e=this.redisUrl||process.env.REDIS_URL||"redis://localhost:6379";return this.client=(0,n.createClient)({url:e}),this.client.on("error",e=>{console.error("Redis rate limiter error:",{error:e instanceof Error?e.message:"Unknown error"})}),await this.client.connect(),this.connecting=!1,this.client}catch(e){throw this.connecting=!1,console.error("Failed to connect to Redis for rate limiting:",{error:e instanceof Error?e.message:"Unknown error"}),e}}async slidingWindow(e,t,r){try{let n;let a=await this.getClient(),s=Date.now(),o=1e3*r,i=a.multi();i.zRemRangeByScore(e,0,s-o),i.zCard(e),i.zAdd(e,{score:s,value:`${s}-${Math.random()}`}),i.expire(e,2*r);let l=await i.exec();if(!l)throw Error("Redis pipeline failed");let c=l[1]||0,p=c<t,u=Math.max(0,t-c-1),d=s+o;if(!p){let t=await a.zRange(e,0,0,{REV:!1});if(t.length>0){let r=await a.zScore(e,t[0]);r&&(n=Math.ceil((r+o-s)/1e3))}n=n||r}return console.log("Rate limit check:",{key:e.substring(0,20)+"...",allowed:p,currentCount:c+1,limit:t,remaining:u,windowSec:r}),{allowed:p,limit:t,remaining:u,resetTime:d,retryAfter:n}}catch(n){return console.error("Rate limiting error:",{key:e.substring(0,20)+"...",error:n instanceof Error?n.message:"Unknown error"}),{allowed:!0,limit:t,remaining:t-1,resetTime:Date.now()+1e3*r}}}async disconnect(){this.client?.isOpen&&await this.client.disconnect()}}let s=null;function o(){return s||(s=new a),s}async function i(e,t,r,n){let a=o(),s=`rate_limit:ip:${t}:${e}`;return await a.slidingWindow(s,r,n)}async function l(e,t,r,n){let a=o(),s=`rate_limit:org:${t}:${e}`;return await a.slidingWindow(s,r,n)}async function c(e,t,r,n){let a=o(),s=`rate_limit:user:${t}:${e}`;return await a.slidingWindow(s,r,n)}async function p(e,t){return await Promise.all(t.map(async t=>{switch(t.type){case"ip":return await i(e,t.id,t.max,t.windowSec);case"org":return await l(e,t.id,t.max,t.windowSec);case"user":return await c(e,t.id,t.max,t.windowSec);default:throw Error(`Unknown limit type: ${t.type}`)}}))}function u(e){return e.some(e=>!e.allowed)}function d(e){return e.find(e=>!e.allowed)||e.reduce((e,t)=>t.remaining<e.remaining?t:e)}let h={PLAN_GENERATE:{ip:{max:10,windowSec:60},org:{max:100,windowSec:3600},user:{max:20,windowSec:300}},PLAN_VALIDATE:{ip:{max:30,windowSec:60},org:{max:500,windowSec:3600},user:{max:60,windowSec:300}},DEPLOY:{ip:{max:5,windowSec:60},org:{max:50,windowSec:3600},user:{max:10,windowSec:300}},WEBHOOK_INGEST:{ip:{max:100,windowSec:60},org:{max:1e3,windowSec:3600}},HEALTH_CHECK:{ip:{max:60,windowSec:60}},API_DEFAULT:{ip:{max:100,windowSec:60},org:{max:1e3,windowSec:3600},user:{max:200,windowSec:300}}};async function g(e,t,r){let n=h[e],a=[];return n.ip&&a.push({type:"ip",id:r.ip,max:n.ip.max,windowSec:n.ip.windowSec}),n.org&&r.orgId&&a.push({type:"org",id:r.orgId,max:n.org.max,windowSec:n.org.windowSec}),n.user&&r.userId&&a.push({type:"user",id:r.userId,max:n.user.max,windowSec:n.user.windowSec}),await p(t,a)}},70907:(e,t,r)=>{r.d(t,{NH:()=>p});var n=r(19619),a=r.n(n),s=r(28586),o=r.n(s);let i={type:"object",properties:{field:{type:"string"},op:{type:"string",enum:["contains","equals","gt","lt","regex"]},value:{}},required:["field","op","value"],additionalProperties:!1},l=new(a())({allErrors:!0,verbose:!0,strict:!0,removeAdditional:!1});o()(l),l.addSchema({$id:"stepSchema",oneOf:[{type:"object",properties:{type:{type:"string",const:"trigger.http"},path:{type:"string"},secretHmac:{type:"boolean"}},required:["type","path","secretHmac"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"filter"},when:i},required:["type","when"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"action.slack.postMessage"},channel:{type:"string"},text:{type:"string"}},required:["type","channel","text"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"action.http.request"},method:{type:"string",enum:["GET","POST","PUT","DELETE"]},url:{type:"string"},headers:{type:"object",nullable:!0,additionalProperties:!0},body:{type:"object",nullable:!0,additionalProperties:!0}},required:["type","method","url"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"custom.action"},actionSlug:{type:"string"},input:{type:"object",nullable:!0,additionalProperties:!0}},required:["type","actionSlug"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"branch"},cases:{type:"array",items:{type:"object",properties:{when:i,steps:{type:"array",items:{$ref:"stepSchema"}}},required:["when","steps"],additionalProperties:!1},minItems:1},else:{type:"array",items:{$ref:"stepSchema"},nullable:!0}},required:["type","cases"],additionalProperties:!1}]});let c=l.compile({type:"object",properties:{version:{type:"string",const:"1"},name:{type:"string",minLength:1,maxLength:100},steps:{type:"array",items:{$ref:"stepSchema"},minItems:1,maxItems:50}},required:["version","name","steps"],additionalProperties:!1});function p(e){return c(e)?{valid:!0,errors:[],data:e}:{valid:!1,errors:c.errors?.map(e=>{let t=e.instancePath||"root",r=e.message||"validation failed";if("required"===e.keyword){let r=e.params?.missingProperty;return`Missing required property "${r}" at ${t}`}if("enum"===e.keyword){let r=e.params?.allowedValues;return`Invalid value at ${t}. Must be one of: ${r?.join(", ")}`}if("const"===e.keyword){let r=e.params?.allowedValue;return`Invalid value at ${t}. Must be: ${r}`}if("minItems"===e.keyword){let r=e.params?.limit;return`Array at ${t} must have at least ${r} items`}if("maxItems"===e.keyword){let r=e.params?.limit;return`Array at ${t} must have no more than ${r} items`}if("minLength"===e.keyword){let r=e.params?.limit;return`String at ${t} must be at least ${r} characters long`}if("maxLength"===e.keyword){let r=e.params?.limit;return`String at ${t} must be no more than ${r} characters long`}return"oneOf"===e.keyword?`Invalid step type at ${t}. Must be one of: trigger.http, filter, branch, action.slack.postMessage, action.http.request, custom.action`:`${r} at ${t}`})||["Unknown validation error"]}}},93953:(e,t,r)=>{r.d(t,{MD:()=>l,mn:()=>c,us:()=>i});var n=r(70907);async function a(e,t){return console.log(`TODO: Resolve action slug "${e}" for org ${t.slice(0,8)}...`),!1}function s(e,t){let r=`steps[${e}]`;return t?`${r}.${t}`:r}async function o(e,t,r,n){let i=[],l=n?`${n}.steps[${t}]`:s(t);if("custom.action"!==e.type||await a(e.actionSlug,r)||i.push({path:`${l}.actionSlug`,code:"UNKNOWN_ACTION_SLUG",message:`Custom action "${e.actionSlug}" is not available for your organization. Check the spelling or contact support to add this action.`}),"action.http.request"===e.type&&!function(e){try{let t=new URL(e).hostname.toLowerCase();return["api.slack.com","hooks.slack.com","api.github.com","api.salesforce.com","graph.microsoft.com","api.hubspot.com","api.stripe.com","api.zapier.com","jsonplaceholder.typicode.com"].some(e=>t===e||t.endsWith(`.${e}`))}catch{return!1}}(e.url)&&i.push({path:`${l}.url`,code:"FORBIDDEN_HOST",message:`HTTP requests to ${function(e){try{let t=new URL(e);return`${t.protocol}//${t.hostname}${t.pathname?"/...":""}`}catch{return"[INVALID_URL]"}}(e.url)} are not allowed. Contact support to allowlist this host.`}),"branch"===e.type){for(let t=0;t<e.cases.length;t++){let n=e.cases[t],a=`${l}.cases[${t}]`;if(n.steps&&0!==n.steps.length)for(let e=0;e<n.steps.length;e++){let t=await o(n.steps[e],e,r,a);i.push(...t)}else i.push({path:`${a}.steps`,code:"EMPTY_BRANCH_CASE",message:"Branch cases must contain at least one step. Add an action or remove this case."})}if(e.else){if(0===e.else.length)i.push({path:`${l}.else`,code:"EMPTY_BRANCH_ELSE",message:"Branch else clause cannot be empty. Add steps or remove the else clause."});else for(let t=0;t<e.else.length;t++){let n=await o(e.else[t],t,r,`${l}.else`);i.push(...n)}}}return i}async function i(e,t){let r=[],a=(0,n.NH)(e);if(!a.valid)return{valid:!1,issues:a.errors.map(e=>({path:"schema",code:"SCHEMA_VALIDATION_FAILED",message:e}))};let i=a.data;try{0===i.steps.length?r.push({path:"steps",code:"NO_STEPS",message:"Plan must contain at least one step."}):i.steps[0].type.startsWith("trigger.")||r.push({path:"steps[0].type",code:"MUST_START_WITH_TRIGGER",message:"Plan must start with a trigger step (e.g., trigger.http). Add a trigger as the first step."});for(let e=0;e<i.steps.length;e++){let n=await o(i.steps[e],e,t.orgId);r.push(...n)}i.steps.filter(e=>e.type.startsWith("trigger.")).length>1&&r.push({path:"steps",code:"MULTIPLE_TRIGGERS",message:"Plan can only have one trigger step. Remove extra trigger steps or create separate plans."}),i.steps.forEach((e,t)=>{"action.slack.postMessage"!==e.type||e.channel.startsWith("#")||e.channel.startsWith("@")||r.push({path:s(t,"channel"),code:"INVALID_SLACK_CHANNEL",message:`Slack channel must start with # for channels or @ for users. Got: "${e.channel}"`})}),i.steps.forEach((e,t)=>{"trigger.http"===e.type&&(e.path.startsWith("/")||r.push({path:s(t,"path"),code:"INVALID_WEBHOOK_PATH",message:`Webhook path must start with /. Got: "${e.path}"`}),(e.path.includes(" ")||e.path.includes("?"))&&r.push({path:s(t,"path"),code:"INVALID_WEBHOOK_PATH_FORMAT",message:`Webhook path cannot contain spaces or query parameters. Got: "${e.path}"`}))})}catch(e){console.error("Error during plan validation:",{orgId:t.orgId.slice(0,8)+"...",error:e instanceof Error?e.message:"Unknown error"}),r.push({path:"validation",code:"VALIDATION_ERROR",message:"An error occurred during plan validation. Please try again."})}return{valid:0===r.length,issues:r}}function l(e){if(e.valid)return"Plan is valid and ready to use.";let t=e.issues.length,r=e.issues.filter(e=>"SCHEMA_VALIDATION_FAILED"===e.code||"MUST_START_WITH_TRIGGER"===e.code).length;return r>0?`Plan has ${t} issue${t>1?"s":""} including ${r} critical error${r>1?"s":""}. Fix critical errors first.`:`Plan has ${t} issue${t>1?"s":""} that should be addressed before deployment.`}function c(e){let t=e.filter(e=>"SCHEMA_VALIDATION_FAILED"===e.code||"MUST_START_WITH_TRIGGER"===e.code||"NO_STEPS"===e.code||"EMPTY_BRANCH_CASE"===e.code),r=e.filter(e=>"UNKNOWN_ACTION_SLUG"===e.code||"FORBIDDEN_HOST"===e.code||"MULTIPLE_TRIGGERS"===e.code),n=e.filter(e=>!t.includes(e)&&!r.includes(e));return{critical:t,warning:r,info:n}}}};