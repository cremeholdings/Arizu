"use strict";(()=>{var e={};e.id=662,e.ids=[662],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},54640:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>C,requestAsyncStorage:()=>E,routeModule:()=>A,serverHooks:()=>_,staticGenerationAsyncStorage:()=>O});var n={};r.r(n),r.d(n,{GET:()=>R,POST:()=>S});var o=r(49303),i=r(88716),s=r(60670),a=r(87070),c=r(21067),l=r(59698),d=r(8466),u=r(71615),p=r(84770),f=r(55227),h=r(79984);class g{constructor(e){this.redisUrl=e,this.client=null,this.connecting=!1}async getClient(){if(this.client?.isOpen)return this.client;if(this.connecting)return await new Promise(e=>setTimeout(e,100)),this.getClient();try{this.connecting=!0;let e=this.redisUrl||process.env.REDIS_URL||"redis://localhost:6379";return this.client=(0,h.createClient)({url:e}),this.client.on("error",e=>{console.error("Redis idempotency error:",{error:e instanceof Error?e.message:"Unknown error"})}),await this.client.connect(),this.connecting=!1,this.client}catch(e){throw this.connecting=!1,console.error("Failed to connect to Redis for idempotency:",{error:e instanceof Error?e.message:"Unknown error"}),e}}async store(e,t,r){let n=`idempotent:${e}`;try{let o=await this.getClient(),i=await o.get(n);if(i){console.log("Idempotency cache hit:",{requestId:e.substring(0,20)+"...",key:n.substring(0,30)+"..."});try{return{value:JSON.parse(i),cached:!0,requestId:e}}catch(t){console.warn("Failed to parse cached idempotent result:",{requestId:e.substring(0,20)+"...",error:t instanceof Error?t.message:"Unknown error"})}}console.log("Idempotency cache miss, computing result:",{requestId:e.substring(0,20)+"...",ttlSec:t});let s=await r();try{let r=JSON.stringify(s);await o.setEx(n,t,r),console.log("Idempotency result cached:",{requestId:e.substring(0,20)+"...",ttlSec:t,resultSize:r.length})}catch(t){console.warn("Failed to store idempotent result in cache:",{requestId:e.substring(0,20)+"...",error:t instanceof Error?t.message:"Unknown error"})}return{value:s,cached:!1,requestId:e}}catch(t){return console.error("Idempotency operation failed, computing without cache:",{requestId:e.substring(0,20)+"...",error:t instanceof Error?t.message:"Unknown error"}),{value:await r(),cached:!1,requestId:e}}}async invalidate(e){let t=`idempotent:${e}`;try{let r=await this.getClient();await r.del(t),console.log("Idempotency cache invalidated:",{requestId:e.substring(0,20)+"...",key:t.substring(0,30)+"..."})}catch(t){console.warn("Failed to invalidate idempotency cache:",{requestId:e.substring(0,20)+"...",error:t instanceof Error?t.message:"Unknown error"})}}async exists(e){let t=`idempotent:${e}`;try{let e=await this.getClient(),r=await e.exists(t);return 1===r}catch(t){return console.warn("Failed to check idempotency cache existence:",{requestId:e.substring(0,20)+"...",error:t instanceof Error?t.message:"Unknown error"}),!1}}async disconnect(){this.client?.isOpen&&await this.client.disconnect()}}let m=null;async function w(e,t,r){if(!e||0===e.trim().length)throw Error("Request ID is required for idempotency");if(t<=0)throw Error("TTL must be greater than 0");let n=(m||(m=new g),m);return await n.store(e,t,r)}async function y(e,t,n,o={}){let i=function(e){for(let t of["idempotency-key","idempotency-id","x-idempotency-key","x-idempotency-id","x-request-id","x-delivery-id","delivery-id"]){let r=e.get(t);if(r&&r.trim().length>0)return r.trim()}return null}(e.headers);if(!i&&o.generateIdFromBody)try{let t=await e.text(),n=new URL(e.url);i=function(e){let t=[e.method,e.path,e.userId||"anonymous",e.orgId||"no-org"];if(e.body)try{let n="string"==typeof e.body?e.body:JSON.stringify(e.body),o=r(84770).createHash("sha256").update(n).digest("hex");t.push(o.substring(0,16))}catch{t.push("body-hash-failed")}return e.timestamp&&t.push(Math.floor(e.timestamp/1e3).toString()),t.join(":")}({method:e.method,path:n.pathname,body:t,timestamp:Date.now()})}catch(e){console.warn("Failed to generate request ID from body:",{error:e instanceof Error?e.message:"Unknown error"})}return i?await w(i,t,n):{value:await n(),cached:!1,requestId:"no-id-"+Date.now()}}let x={WEBHOOK_PROCESSING:{ttlSec:3600}};var b=r(60594);let k=c.Ry({event:c.Km(["run.started","run.completed","run.failed"]),runId:c.Z_().min(1),orgId:c.Z_().min(1),automationId:c.Z_().optional(),userId:c.Z_().optional(),timestamp:c.Z_().datetime().optional(),data:c.Ry({executionTime:c.Rx().optional(),errorMessage:c.Z_().optional(),inputData:c.IM(c.Yj()).optional(),outputData:c.IM(c.Yj()).optional(),stepLogs:c.IX(c.Ry({step:c.Z_(),input:c.IM(c.Yj()).optional(),output:c.IM(c.Yj()).optional(),error:c.Z_().optional(),timestamp:c.Z_().datetime().optional()})).optional()}).optional()});async function v(e,t){let r=(0,u.headers)(),n=r.get("x-hub-signature-256")||r.get("x-n8n-signature")||r.get("x-signature");if(!n)return console.warn("Webhook missing signature header"),!1;let o=process.env.WEBHOOK_SECRET||process.env.N8N_WEBHOOK_SECRET;return o?function(e,t,r){try{let n=t.replace(/^sha256=/,""),o=(0,p.createHmac)("sha256",r);o.update(e);let i=o.digest("hex"),s=Buffer.from(n,"hex"),a=Buffer.from(i,"hex");return s.length===a.length&&(0,p.timingSafeEqual)(s,a)}catch(e){return console.error("HMAC verification error",{error:e instanceof Error?e.message:"Unknown error"}),!1}}(t,n,o):(console.error("No webhook secret configured"),!1)}async function S(e){try{let t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"127.0.0.1",r=await (0,f.Iy)("WEBHOOK_INGEST","/api/hooks/ingest",{ip:t});if((0,f.V1)(r)){let e=(0,f.dK)(r);console.warn("Webhook ingestion rate limited",{ip:t,limit:e.limit,remaining:e.remaining,retryAfter:e.retryAfter});let n=(0,b.hb)("Rate limit exceeded. Please wait before sending more webhooks.",e.retryAfter||60,{retryAfterSec:e.retryAfter||60,resetTime:e.resetTime,endpoint:"/api/hooks/ingest"});return a.NextResponse.json(n,{status:(0,b.rY)(n),headers:{"Retry-After":String(e.retryAfter||60),"X-RateLimit-Limit":String(e.limit),"X-RateLimit-Remaining":String(e.remaining),"X-RateLimit-Reset":String(e.resetTime)}})}let n=await e.text();if(!await v(e,n))return console.warn("Webhook authentication failed",{hasPayload:!!n,payloadLength:n.length,userAgent:e.headers.get("user-agent")}),a.NextResponse.json({ok:!1,error:"Authentication failed"},{status:401});let o=function(e){for(let t of["x-hub-delivery","x-github-delivery","x-gitlab-event-uuid","x-delivery-id","delivery-id"]){let r=e.get(t);if(r&&r.trim().length>0)return r.trim()}return null}(e.headers);o||console.warn("Webhook missing delivery ID header",{userAgent:e.headers.get("user-agent"),availableHeaders:[...e.headers.keys()].filter(e=>e.startsWith("x-"))});let i=await y(e,x.WEBHOOK_PROCESSING.ttlSec,async()=>{let e;try{e=JSON.parse(n)}catch(e){throw console.error("Invalid JSON in webhook payload",{payloadPreview:n.substring(0,200),error:e instanceof Error?e.message:"Unknown error"}),Error("Invalid JSON payload")}let t=k.safeParse(e);if(!t.success)throw console.error("Invalid webhook payload schema",{errors:t.error.issues,payload:e}),Error("Invalid payload schema");let r=t.data;console.log("Processing webhook event",{event:r.event,runId:r.runId.slice(0,8)+"...",orgId:r.orgId.slice(0,8)+"...",automationId:r.automationId?.slice(0,8)+"...",cached:!1,deliveryId:o?.substring(0,20)+"..."});try{return await I(r)}catch(e){if(e instanceof b.hr)return e.response;throw e}},{generateIdFromBody:!o});i.cached&&console.log("Webhook event processed from cache",{requestId:i.requestId.substring(0,20)+"...",cached:!0});let s=i.value;if(!s.ok&&s.code){let e=(0,b.rY)(s),t={};return s.retryAfterSec&&(t["Retry-After"]=String(s.retryAfterSec)),a.NextResponse.json(s,{status:e,headers:Object.keys(t).length>0?t:void 0})}return a.NextResponse.json(s)}catch(t){if(t instanceof b.hr){let e=t.response,r={};return e.retryAfterSec&&(r["Retry-After"]=String(e.retryAfterSec)),a.NextResponse.json(e,{status:(0,b.rY)(e),headers:Object.keys(r).length>0?r:void 0})}console.error("Webhook ingestion error",{error:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0});let e=(0,b.I3)("Internal server error. Failed to process webhook.");return a.NextResponse.json(e,{status:(0,b.rY)(e)})}}async function I(e){switch(e.event){case"run.started":if(await (0,l.zQ)(e.orgId,e.runId,e.automationId,e.userId),e.data?.stepLogs?.length)for(let t of e.data.stepLogs)await (0,d.TH)(e.runId,{step:t.step,input:t.input,output:t.output,error:t.error});break;case"run.completed":if(await (0,l.Mk)(e.orgId,e.runId,{status:"ok",executionTime:e.data?.executionTime,outputData:e.data?.outputData}),e.data?.stepLogs?.length)for(let t of e.data.stepLogs)await (0,d.TH)(e.runId,{step:t.step,input:t.input,output:t.output,error:t.error});break;case"run.failed":if(await (0,l.Mk)(e.orgId,e.runId,{status:"error",errorMessage:e.data?.errorMessage,executionTime:e.data?.executionTime}),e.data?.stepLogs?.length)for(let t of e.data.stepLogs)await (0,d.TH)(e.runId,{step:t.step,input:t.input,output:t.output,error:t.error});break;default:throw console.warn("Unknown webhook event type",{event:e.event,runId:e.runId.slice(0,8)+"..."}),Error(`Unknown event type: ${e.event}`)}return console.log("Webhook event processed successfully",{event:e.event,runId:e.runId.slice(0,8)+"...",orgId:e.orgId.slice(0,8)+"..."}),{ok:!0}}async function R(){return a.NextResponse.json({ok:!0,service:"webhook-ingest",timestamp:new Date().toISOString(),endpoints:{POST:"Process run events from n8n"},requiredHeaders:["x-hub-signature-256","x-n8n-signature","x-signature"],supportedEvents:["run.started","run.completed","run.failed"]})}let A=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/hooks/ingest/route",pathname:"/api/hooks/ingest",filename:"route",bundlePath:"app/api/hooks/ingest/route"},resolvedPagePath:"/Users/ediyaffe/Documents/GitHub/Arizu/app/api/hooks/ingest/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:E,staticGenerationAsyncStorage:O,serverHooks:_}=A,j="/api/hooks/ingest/route";function C(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:O})}},55227:(e,t,r)=>{r.d(t,{Iy:()=>h,V1:()=>u,dK:()=>p});var n=r(79984);class o{constructor(e){this.redisUrl=e,this.client=null,this.connecting=!1}async getClient(){if(this.client?.isOpen)return this.client;if(this.connecting)return await new Promise(e=>setTimeout(e,100)),this.getClient();try{this.connecting=!0;let e=this.redisUrl||process.env.REDIS_URL||"redis://localhost:6379";return this.client=(0,n.createClient)({url:e}),this.client.on("error",e=>{console.error("Redis rate limiter error:",{error:e instanceof Error?e.message:"Unknown error"})}),await this.client.connect(),this.connecting=!1,this.client}catch(e){throw this.connecting=!1,console.error("Failed to connect to Redis for rate limiting:",{error:e instanceof Error?e.message:"Unknown error"}),e}}async slidingWindow(e,t,r){try{let n;let o=await this.getClient(),i=Date.now(),s=1e3*r,a=o.multi();a.zRemRangeByScore(e,0,i-s),a.zCard(e),a.zAdd(e,{score:i,value:`${i}-${Math.random()}`}),a.expire(e,2*r);let c=await a.exec();if(!c)throw Error("Redis pipeline failed");let l=c[1]||0,d=l<t,u=Math.max(0,t-l-1),p=i+s;if(!d){let t=await o.zRange(e,0,0,{REV:!1});if(t.length>0){let r=await o.zScore(e,t[0]);r&&(n=Math.ceil((r+s-i)/1e3))}n=n||r}return console.log("Rate limit check:",{key:e.substring(0,20)+"...",allowed:d,currentCount:l+1,limit:t,remaining:u,windowSec:r}),{allowed:d,limit:t,remaining:u,resetTime:p,retryAfter:n}}catch(n){return console.error("Rate limiting error:",{key:e.substring(0,20)+"...",error:n instanceof Error?n.message:"Unknown error"}),{allowed:!0,limit:t,remaining:t-1,resetTime:Date.now()+1e3*r}}}async disconnect(){this.client?.isOpen&&await this.client.disconnect()}}let i=null;function s(){return i||(i=new o),i}async function a(e,t,r,n){let o=s(),i=`rate_limit:ip:${t}:${e}`;return await o.slidingWindow(i,r,n)}async function c(e,t,r,n){let o=s(),i=`rate_limit:org:${t}:${e}`;return await o.slidingWindow(i,r,n)}async function l(e,t,r,n){let o=s(),i=`rate_limit:user:${t}:${e}`;return await o.slidingWindow(i,r,n)}async function d(e,t){return await Promise.all(t.map(async t=>{switch(t.type){case"ip":return await a(e,t.id,t.max,t.windowSec);case"org":return await c(e,t.id,t.max,t.windowSec);case"user":return await l(e,t.id,t.max,t.windowSec);default:throw Error(`Unknown limit type: ${t.type}`)}}))}function u(e){return e.some(e=>!e.allowed)}function p(e){return e.find(e=>!e.allowed)||e.reduce((e,t)=>t.remaining<e.remaining?t:e)}let f={PLAN_GENERATE:{ip:{max:10,windowSec:60},org:{max:100,windowSec:3600},user:{max:20,windowSec:300}},PLAN_VALIDATE:{ip:{max:30,windowSec:60},org:{max:500,windowSec:3600},user:{max:60,windowSec:300}},DEPLOY:{ip:{max:5,windowSec:60},org:{max:50,windowSec:3600},user:{max:10,windowSec:300}},WEBHOOK_INGEST:{ip:{max:100,windowSec:60},org:{max:1e3,windowSec:3600}},HEALTH_CHECK:{ip:{max:60,windowSec:60}},API_DEFAULT:{ip:{max:100,windowSec:60},org:{max:1e3,windowSec:3600},user:{max:200,windowSec:300}}};async function h(e,t,r){let n=f[e],o=[];return n.ip&&o.push({type:"ip",id:r.ip,max:n.ip.max,windowSec:n.ip.windowSec}),n.org&&r.orgId&&o.push({type:"org",id:r.orgId,max:n.org.max,windowSec:n.org.windowSec}),n.user&&r.userId&&o.push({type:"user",id:r.userId,max:n.user.max,windowSec:n.user.windowSec}),await d(t,o)}},71615:(e,t,r)=>{r.r(t);var n=r(88757),o={};for(let e in n)"default"!==e&&(o[e]=()=>n[e]);r.d(t,o)},33085:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"DraftMode",{enumerable:!0,get:function(){return i}});let n=r(45869),o=r(6278);class i{get isEnabled(){return this._provider.isEnabled}enable(){let e=n.staticGenerationAsyncStorage.getStore();return e&&(0,o.trackDynamicDataAccessed)(e,"draftMode().enable()"),this._provider.enable()}disable(){let e=n.staticGenerationAsyncStorage.getStore();return e&&(0,o.trackDynamicDataAccessed)(e,"draftMode().disable()"),this._provider.disable()}constructor(e){this._provider=e}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},88757:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{cookies:function(){return p},draftMode:function(){return f},headers:function(){return u}});let n=r(68996),o=r(53047),i=r(92044),s=r(72934),a=r(33085),c=r(6278),l=r(45869),d=r(54580);function u(){let e="headers",t=l.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return o.HeadersAdapter.seal(new Headers({}));(0,c.trackDynamicDataAccessed)(t,e)}return(0,d.getExpectedRequestStore)(e).headers}function p(){let e="cookies",t=l.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return n.RequestCookiesAdapter.seal(new i.RequestCookies(new Headers({})));(0,c.trackDynamicDataAccessed)(t,e)}let r=(0,d.getExpectedRequestStore)(e),o=s.actionAsyncStorage.getStore();return(null==o?void 0:o.isAction)||(null==o?void 0:o.isAppRoute)?r.mutableCookies:r.cookies}function f(){let e=(0,d.getExpectedRequestStore)("draftMode");return new a.DraftMode(e.draftMode)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},53047:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{HeadersAdapter:function(){return i},ReadonlyHeadersError:function(){return o}});let n=r(38238);class o extends Error{constructor(){super("Headers cannot be modified. Read more: https://nextjs.org/docs/app/api-reference/functions/headers")}static callable(){throw new o}}class i extends Headers{constructor(e){super(),this.headers=new Proxy(e,{get(t,r,o){if("symbol"==typeof r)return n.ReflectAdapter.get(t,r,o);let i=r.toLowerCase(),s=Object.keys(e).find(e=>e.toLowerCase()===i);if(void 0!==s)return n.ReflectAdapter.get(t,s,o)},set(t,r,o,i){if("symbol"==typeof r)return n.ReflectAdapter.set(t,r,o,i);let s=r.toLowerCase(),a=Object.keys(e).find(e=>e.toLowerCase()===s);return n.ReflectAdapter.set(t,a??r,o,i)},has(t,r){if("symbol"==typeof r)return n.ReflectAdapter.has(t,r);let o=r.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===o);return void 0!==i&&n.ReflectAdapter.has(t,i)},deleteProperty(t,r){if("symbol"==typeof r)return n.ReflectAdapter.deleteProperty(t,r);let o=r.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===o);return void 0===i||n.ReflectAdapter.deleteProperty(t,i)}})}static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"append":case"delete":case"set":return o.callable;default:return n.ReflectAdapter.get(e,t,r)}}})}merge(e){return Array.isArray(e)?e.join(", "):e}static from(e){return e instanceof Headers?e:new i(e)}append(e,t){let r=this.headers[e];"string"==typeof r?this.headers[e]=[r,t]:Array.isArray(r)?r.push(t):this.headers[e]=t}delete(e){delete this.headers[e]}get(e){let t=this.headers[e];return void 0!==t?this.merge(t):null}has(e){return void 0!==this.headers[e]}set(e,t){this.headers[e]=t}forEach(e,t){for(let[r,n]of this.entries())e.call(t,n,r,this)}*entries(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase(),r=this.get(t);yield[t,r]}}*keys(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase();yield t}}*values(){for(let e of Object.keys(this.headers)){let t=this.get(e);yield t}}[Symbol.iterator](){return this.entries()}}},68996:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{MutableRequestCookiesAdapter:function(){return u},ReadonlyRequestCookiesError:function(){return s},RequestCookiesAdapter:function(){return a},appendMutableCookies:function(){return d},getModifiedCookieValues:function(){return l}});let n=r(92044),o=r(38238),i=r(45869);class s extends Error{constructor(){super("Cookies can only be modified in a Server Action or Route Handler. Read more: https://nextjs.org/docs/app/api-reference/functions/cookies#cookiessetname-value-options")}static callable(){throw new s}}class a{static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"clear":case"delete":case"set":return s.callable;default:return o.ReflectAdapter.get(e,t,r)}}})}}let c=Symbol.for("next.mutated.cookies");function l(e){let t=e[c];return t&&Array.isArray(t)&&0!==t.length?t:[]}function d(e,t){let r=l(t);if(0===r.length)return!1;let o=new n.ResponseCookies(e),i=o.getAll();for(let e of r)o.set(e);for(let e of i)o.set(e);return!0}class u{static wrap(e,t){let r=new n.ResponseCookies(new Headers);for(let t of e.getAll())r.set(t);let s=[],a=new Set,l=()=>{let e=i.staticGenerationAsyncStorage.getStore();if(e&&(e.pathWasRevalidated=!0),s=r.getAll().filter(e=>a.has(e.name)),t){let e=[];for(let t of s){let r=new n.ResponseCookies(new Headers);r.set(t),e.push(r.toString())}t(e)}};return new Proxy(r,{get(e,t,r){switch(t){case c:return s;case"delete":return function(...t){a.add("string"==typeof t[0]?t[0]:t[0].name);try{e.delete(...t)}finally{l()}};case"set":return function(...t){a.add("string"==typeof t[0]?t[0]:t[0].name);try{return e.set(...t)}finally{l()}};default:return o.ReflectAdapter.get(e,t,r)}}})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,70,984,696,599],()=>r(54640));module.exports=n})();