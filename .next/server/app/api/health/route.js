"use strict";(()=>{var e={};e.id=829,e.ids=[829],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},98216:e=>{e.exports=require("net")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71447:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>T,requestAsyncStorage:()=>A,routeModule:()=>b,serverHooks:()=>C,staticGenerationAsyncStorage:()=>D});var s={};r.r(s),r.d(s,{GET:()=>E,HEAD:()=>N,OPTIONS:()=>P});var n=r(49303),a=r(88716),o=r(60670),i=r(87070),l=r(9487),c=r(39021);async function u(){let e=Date.now();try{await l.db.$queryRaw`SELECT 1 as health_check`;let t=Date.now()-e;return{status:"ok",responseTime:t}}catch(r){let t=Date.now()-e;return console.error("Database health check failed",{error:r instanceof Error?r.message:"Unknown error",responseTime:t}),{status:"down",message:"Database connection failed",responseTime:t}}}async function h(){let e=Date.now();try{let{createClient:t}=await r.e(984).then(r.t.bind(r,79984,23)),s=process.env.REDIS_URL||"redis://localhost:6379",n=t({url:s});await n.connect();let a=await n.ping();await n.disconnect();let o=Date.now()-e;if("PONG"===a)return{status:"ok",responseTime:o};return{status:"down",message:"Redis ping failed",responseTime:o}}catch(r){let t=Date.now()-e;return console.error("Redis health check failed",{error:r instanceof Error?r.message:"Unknown error",responseTime:t}),{status:"down",message:"Redis connection failed",responseTime:t}}}async function p(e){let t=Date.now();try{let r=e||new c.kN({baseURL:process.env.N8N_API_URL||"http://localhost:5678",apiKey:process.env.N8N_API_KEY||""});await r.listWorkflows();let s=Date.now()-t;return{status:"ok",responseTime:s}}catch(r){let e=Date.now()-t;return console.error("n8n health check failed",{error:r instanceof Error?r.message:"Unknown error",responseTime:e}),{status:"down",message:"n8n API connection failed",responseTime:e}}}function d(){try{if(process.env.APP_VERSION)return process.env.APP_VERSION;return"1.0.0"}catch(e){return console.warn("Failed to determine application version",{error:e instanceof Error?e.message:"Unknown error"}),"unknown"}}async function w(e){let[t,r,s]=await Promise.allSettled([u(),h(),p(e)]);return{db:"fulfilled"===t.status?t.value:{status:"down",message:"Health check failed to execute"},redis:"fulfilled"===r.status?r.value:{status:"down",message:"Health check failed to execute"},n8n:"fulfilled"===s.status?s.value:{status:"down",message:"Health check failed to execute"}}}function m(e){return"ok"===e.db.status&&"ok"===e.n8n.status?"ok":"down"}class f{constructor(e=6e4,t=1e3){this.measurements=[],this.windowSizeMs=e,this.maxMeasurements=t}addMeasurement(e){let t=Date.now();this.measurements.push({timestamp:t,value:e}),this.cleanup(t),this.measurements.length>this.maxMeasurements&&(this.measurements=this.measurements.slice(-this.maxMeasurements))}cleanup(e){let t=e-this.windowSizeMs;this.measurements=this.measurements.filter(e=>e.timestamp>t)}getP95(){let e=Date.now();if(this.cleanup(e),0===this.measurements.length)return 0;let t=this.measurements.map(e=>e.value).sort((e,t)=>e-t),r=Math.max(0,Math.min(Math.ceil(.95*t.length)-1,t.length-1));return t[r]||0}getCount(){let e=Date.now();return this.cleanup(e),this.measurements.length}getAverage(){let e=Date.now();return(this.cleanup(e),0===this.measurements.length)?0:this.measurements.reduce((e,t)=>e+t.value,0)/this.measurements.length}getMin(){let e=Date.now();return(this.cleanup(e),0===this.measurements.length)?0:Math.min(...this.measurements.map(e=>e.value))}getMax(){let e=Date.now();return(this.cleanup(e),0===this.measurements.length)?0:Math.max(...this.measurements.map(e=>e.value))}reset(){this.measurements=[]}getStats(){return{count:this.getCount(),average:Math.round(this.getAverage()),min:this.getMin(),max:this.getMax(),p95:Math.round(this.getP95())}}}let g=new f(3e5,2e3),k=new f(3e5,2e3);function y(){return Math.round(g.getP95())}function v(){return Math.round(k.getP95())}let x=JSON.parse('{"availability_app_pct":99.9,"availability_n8n_pct":99.5,"latency_app_p95_ms":2000,"latency_api_p95_ms":3000,"error_budget_pct":0.1}');async function E(e){let t=Date.now();try{console.log("Health check requested",{userAgent:e.headers.get("user-agent"),ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")});let r=new URL(e.url),s="true"===r.searchParams.get("detailed"),n=await w(),a=y(),o=v(),l=m(n),c="ok"===l,u=Date.now()-t,h={ok:c,components:{db:n.db.status,redis:n.redis.status,n8n:n.n8n.status},slo:x,version:d(),p95:{app:a,api:o},timestamp:new Date().toISOString(),responseTime:u};if(s){let e={...h,details:{db:{status:n.db.status,message:n.db.message,responseTime:n.db.responseTime},redis:{status:n.redis.status,message:n.redis.message,responseTime:n.redis.responseTime},n8n:{status:n.n8n.status,message:n.n8n.message,responseTime:n.n8n.responseTime}}};return console.log("Detailed health check completed",{overall:l,components:e.details,latency:e.p95,responseTime:u}),i.NextResponse.json(e,{status:c?200:503,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","Content-Type":"application/json"}})}return console.log("Health check completed",{overall:l,components:h.components,latency:h.p95,responseTime:u}),i.NextResponse.json(h,{status:c?200:503,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","Content-Type":"application/json"}})}catch(s){let e=Date.now()-t;console.error("Health check failed",{error:s instanceof Error?s.message:"Unknown error",stack:s instanceof Error?s.stack:void 0,responseTime:e});let r={ok:!1,components:{db:"down",redis:"down",n8n:"down"},slo:x,version:d(),p95:{app:y(),api:v()},timestamp:new Date().toISOString(),responseTime:e};return i.NextResponse.json(r,{status:503,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","Content-Type":"application/json"}})}}async function N(){try{let e=await w(),t="ok"===m(e);return new i.NextResponse(null,{status:t?200:503,headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}})}catch(e){return console.error("HEAD health check failed",{error:e instanceof Error?e.message:"Unknown error"}),new i.NextResponse(null,{status:503,headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}})}}async function P(){return new i.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Cache-Control":"no-cache, no-store, must-revalidate"}})}let b=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/health/route",pathname:"/api/health",filename:"route",bundlePath:"app/api/health/route"},resolvedPagePath:"/Users/ediyaffe/Documents/GitHub/Arizu/app/api/health/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:A,staticGenerationAsyncStorage:D,serverHooks:C}=b,R="/api/health/route";function T(){return(0,o.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:D})}},9487:(e,t,r)=>{r.d(t,{db:()=>n});var s=r(53524);let n=globalThis.prisma??new s.PrismaClient({log:["query"]})},39021:(e,t,r)=>{r.d(t,{Bv:()=>s,Pe:()=>a,kN:()=>n});class s extends Error{constructor(e,t,r){super(t),this.status=e,this.response=r,this.name="N8nError"}}class n{constructor(e){this.apiBasePath=null,this.baseURL=e.baseURL.replace(/\/$/,""),this.apiKey=e.apiKey}async request(e,t,r){this.apiBasePath||await this.detectApiBasePath();let n=`${this.baseURL}${this.apiBasePath}${t}`,a={"X-N8N-API-KEY":this.apiKey,"Content-Type":"application/json"};console.log(`N8n API request: ${e} ${t}`,{url:n.replace(this.apiKey,"[REDACTED]"),hasBody:!!r,bodySize:r?JSON.stringify(r).length:0});try{let o;let i=await fetch(n,{method:e,headers:a,body:r?JSON.stringify(r):void 0}),l=await i.text();try{o=l?JSON.parse(l):null}catch{o={raw:l}}if(!i.ok)throw console.error("N8n API error",{status:i.status,statusText:i.statusText,url:n.replace(this.apiKey,"[REDACTED]"),response:o}),new s(i.status,`N8n API error (${i.status}): ${o?.message||i.statusText}`,o);return console.log(`N8n API response: ${e} ${t}`,{status:i.status,hasData:!!o,dataSize:l.length}),o}catch(e){if(e instanceof s)throw e;throw console.error("N8n API request failed",{error:e instanceof Error?e.message:"Unknown error",url:n.replace(this.apiKey,"[REDACTED]")}),new s(0,`N8n API request failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async detectApiBasePath(){for(let e of["/api/v1","/rest"])try{this.apiBasePath=e,await this.getVersion(),console.log(`N8n API base path detected: ${e}`);return}catch(t){console.log(`N8n API path ${e} failed, trying next...`);continue}throw new s(0,"Could not detect N8n API base path. Tried /api/v1 and /rest. Check your N8n installation and API configuration.")}async getVersion(){return this.request("GET","/")}async listWorkflows(){return(await this.request("GET","/workflows")).data||[]}async getWorkflow(e){return this.request("GET",`/workflows/${e}`)}async createWorkflow(e){return this.request("POST","/workflows",e)}async updateWorkflow(e,t){return this.request("PUT",`/workflows/${e}`,t)}async activateWorkflow(e,t){return this.request("PATCH",`/workflows/${e}`,{active:t})}async deleteWorkflow(e){await this.request("DELETE",`/workflows/${e}`)}async upsertByName(e,t){try{let r;let s=(await this.listWorkflows()).find(t=>t.name===e),n={name:t.name||e,nodes:t.nodes,connections:t.connections,active:!1,settings:{timezone:"America/New_York",saveDataErrorExecution:"all",saveDataSuccessExecution:"all",saveManualExecutions:!0},tags:["arizu-generated"]},a=!1;s?(console.log(`Updating existing workflow: ${e} (${s.id})`),r=await this.updateWorkflow(s.id,n)):(console.log(`Creating new workflow: ${e}`),r=await this.createWorkflow(n),a=!0);let o=this.extractWebhookUrl(r);return{workflowId:r.id,isNew:a,webhookUrl:o}}catch(t){if(console.error("Failed to upsert workflow",{name:e,error:t instanceof Error?t.message:"Unknown error"}),t instanceof s)throw t;throw new s(0,`Failed to upsert workflow "${e}": ${t instanceof Error?t.message:"Unknown error"}`)}}extractWebhookUrl(e){try{let t=e.nodes?.find(e=>"n8n-nodes-base.webhook"===e.type&&e.webhookId);if(t&&t.parameters?.path){let e=t.parameters.path,r=this.baseURL.replace(/\/api.*$/,"");return`${r}/webhook${e}`}return}catch(e){console.warn("Failed to extract webhook URL",{error:e instanceof Error?e.message:"Unknown error"});return}}async getWorkflowByName(e){try{return(await this.listWorkflows()).find(t=>t.name===e)||null}catch(t){return console.error("Failed to get workflow by name",{name:e,error:t instanceof Error?t.message:"Unknown error"}),null}}async healthCheck(){try{return await this.getVersion(),!0}catch(e){return console.error("N8n health check failed",{baseURL:this.baseURL,error:e instanceof Error?e.message:"Unknown error"}),!1}}}function a(){let e=process.env.N8N_URL,t=process.env.N8N_API_KEY;if(!e)throw Error("N8N_URL environment variable is required");if(!t)throw Error("N8N_API_KEY environment variable is required");return new n({baseURL:e,apiKey:t})}},49303:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,70],()=>r(71447));module.exports=s})();