"use strict";(()=>{var e={};e.id=348,e.ids=[348],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},35816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("worker_threads")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},49352:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>S,requestAsyncStorage:()=>T,routeModule:()=>v,serverHooks:()=>A,staticGenerationAsyncStorage:()=>P});var s={};r.r(s),r.d(s,{POST:()=>b});var o=r(49303),n=r(88716),a=r(60670),i=r(87070),l=r(96471),c=r(21067),u=r(93953);let p={nodeWidth:240,nodeHeight:100,horizontalSpacing:300,verticalSpacing:150,startX:100,startY:100};class d extends Error{constructor(e,t,r){super(t),this.code=e,this.step=r,this.name="CompilerError"}}async function h(e,t){return console.log(`TODO: Resolve action definition "${e}" for org ${t.slice(0,8)}...`),null}function g(e){return e.replace(/[^a-zA-Z0-9_]/g,"_").substring(0,50)}function m(e){return e.replace(/\{\{([^}]+)\}\}/g,(e,t)=>{let r=t.trim();if(r.startsWith("secrets.")){let e=r.replace("secrets.","");return`{{ $vars.${e} }}`}return`{{ $json.${r} }}`})}function f(e){let t=`{{ $json.${e.field} }}`;switch(e.op){case"equals":return{value1:t,operation:"equal",value2:e.value};case"contains":return{value1:t,operation:"contains",value2:e.value};case"gt":return{value1:t,operation:"larger",value2:e.value};case"lt":return{value1:t,operation:"smaller",value2:e.value};case"regex":return{value1:t,operation:"regex",value2:e.value};default:throw new d("UNSUPPORTED_FILTER_OPERATION",`Unsupported filter operation "${e.op}". Supported operations: equals, contains, gt, lt, regex`)}}async function y(e,t,r){let s=await h(e.actionSlug,r);if(!s)throw new d("UNKNOWN_CUSTOM_ACTION",`Custom action "${e.actionSlug}" is not available for your organization. Check the spelling or contact support to add this action.`,e);return{id:t,name:g(`Custom_${e.actionSlug}`),type:"n8n-nodes-base.httpRequest",typeVersion:4,position:[0,0],parameters:{method:s.method.toUpperCase(),url:s.url,authentication:"none",options:{response:{fullResponse:!1},...s.headers&&{headers:Object.entries(s.headers).map(([e,t])=>({name:e,value:"string"==typeof t?m(t):t}))},...s.body&&{bodyContentType:"json",jsonBody:JSON.stringify({...s.body,...e.input},null,2)}}}}}async function w(e,t,r){switch(e.type){case"trigger.http":return{id:t,name:g(`Webhook_${e.path.replace(/[^a-zA-Z0-9]/g,"_")}`),type:"n8n-nodes-base.webhook",typeVersion:1,position:[0,0],parameters:{path:e.path,httpMethod:"POST",responseMode:"responseNode",options:{noResponseBody:!1,...e.secretHmac&&{authentication:"headerAuth",headerAuth:{name:"X-Hub-Signature-256",value:"={{ $vars.webhook_secret }}"}}}},webhookId:`webhook_${Math.random().toString(36).substring(2,15)}`};case"filter":return function(e,t){let r=f(e.when);return{id:t,name:g(`Filter_${e.when.field}`),type:"n8n-nodes-base.if",typeVersion:1,position:[0,0],parameters:{conditions:{string:[r]}}}}(e,t);case"branch":return function(e,t){let r=e.cases.map((e,t)=>({value:t.toString(),condition:f(e.when)}));return{id:t,name:g("Branch_Switch"),type:"n8n-nodes-base.switch",typeVersion:1,position:[0,0],parameters:{dataType:"string",value1:"={{ $json }}",rules:{values:r.map((e,t)=>({conditions:{string:[e.condition]},output:t}))},fallbackOutput:e.else?e.cases.length:-1}}}(e,t);case"action.slack.postMessage":return{id:t,name:g(`Slack_${e.channel.replace("#","").replace("@","")}`),type:"n8n-nodes-base.slack",typeVersion:1,position:[0,0],parameters:{operation:"postMessage",channel:e.channel,text:m(e.text),otherOptions:{},authentication:"oAuth2"}};case"action.http.request":return function(e,t){let r=new URL(e.url);return{id:t,name:g(`HTTP_${r.hostname.replace(/[^a-zA-Z0-9]/g,"_")}`),type:"n8n-nodes-base.httpRequest",typeVersion:4,position:[0,0],parameters:{method:e.method,url:e.url,authentication:"none",options:{response:{fullResponse:!1},...e.headers&&{headers:Object.entries(e.headers).map(([e,t])=>({name:e,value:"string"==typeof t?m(t):t}))},...e.body&&{bodyContentType:"json",jsonBody:JSON.stringify(e.body,null,2)}}}}}(e,t);case"custom.action":return await y(e,t,r);default:throw new d("UNSUPPORTED_STEP_TYPE",`Unsupported step type "${e.type}". Use custom.action for unsupported integrations.`,e)}}async function E(e,t,r,s){let o=[];for(let a of e){var n;let e=(n=r.count++,`node_${n.toString().padStart(3,"0")}`);if("branch"===a.type){s.set(e,{cases:a.cases.length,hasElse:!!a.else});let n=await w(a,e,t);for(let e of(o.push(n),a.cases)){let n=await E(e.steps,t,r,s);o.push(...n)}if(a.else){let e=await E(a.else,t,r,s);o.push(...e)}}else{let r=await w(a,e,t);o.push(r)}}return o}async function k(e,t){try{console.log("Compiling plan to n8n workflow",{planName:e.name,stepCount:e.steps.length,orgId:t.orgId.slice(0,8)+"..."});let r=new Map,s=await E(e.steps,t.orgId,{count:0},r);if(0===s.length)throw new d("NO_NODES_GENERATED","Plan compilation resulted in no nodes. Ensure the plan has valid steps.");let o=function(e,t){let r={};for(let s=0;s<e.length-1;s++){let o=e[s],n=e[s+1];r[o.id]||(r[o.id]={});let a=t.get(o.id);if("n8n-nodes-base.if"===o.type)r[o.id].main=[{source:o.id,sourceOutput:"main",target:n.id,targetInput:"main"},{source:o.id,sourceOutput:"main",target:n.id,targetInput:"main"}];else if("n8n-nodes-base.switch"===o.type&&a){let e=[];for(let t=0;t<a.cases;t++)e.push({source:o.id,sourceOutput:"main",target:n.id,targetInput:"main"});a.hasElse&&e.push({source:o.id,sourceOutput:"main",target:n.id,targetInput:"main"}),r[o.id].main=e}else r[o.id].main=[{source:o.id,sourceOutput:"main",target:n.id,targetInput:"main"}]}return r}(s,r),n=function(e,t,r={}){let s={...p,...r};if(0===e.length)return[];if(1===e.length)return[{...e[0],position:[s.startX,s.startY]}];try{let r=function(e,t){let r=new Map;return e.forEach(e=>{r.set(e.id,[])}),Object.entries(t).forEach(([e,t])=>{Object.values(t).forEach(t=>{t.forEach(t=>{let s=r.get(t.target)||[];s.includes(e)||(s.push(e),r.set(t.target,s))})})}),r}(e,t),o=function(e,t){let r=new Map,s=new Set;return e.forEach(e=>(function e(o){if(s.has(o))return r.get(o)||0;s.add(o);let n=t.get(o)||[];if(0===n.length)return r.set(o,0),0;let a=Math.max(...n.map(t=>e(t)))+1;return r.set(o,a),a})(e.id)),r}(e,r),n=function(e,t){let r=new Map;return e.forEach(e=>{let s=t.get(e.id)||0,o=r.get(s)||[];o.push(e),r.set(s,o)}),r}(e,o),a=function(e,t){let r=new Map;return e.forEach((e,s)=>{let o=t.startX+s*t.horizontalSpacing,n=e.sort((e,t)=>e.name.localeCompare(t.name));n.forEach((e,s)=>{let a=n.length*t.nodeHeight+(n.length-1)*t.verticalSpacing,i=t.startY-a/2+s*(t.nodeHeight+t.verticalSpacing);r.set(e.id,[o,i])})}),r}(n,s);return e.map(e=>({...e,position:a.get(e.id)||[s.startX,s.startY]}))}catch(t){return console.warn("Auto-layout failed, falling back to simple grid layout",{error:t instanceof Error?t.message:"Unknown error",nodeCount:e.length}),e.map((e,t)=>({...e,position:[s.startX+t%3*s.horizontalSpacing,s.startY+Math.floor(t/3)*s.verticalSpacing]}))}}(s,o),a={nodes:n,connections:o,name:e.name};return console.log("Plan compiled successfully",{planName:e.name,nodeCount:n.length,connectionCount:Object.keys(o).length,orgId:t.orgId.slice(0,8)+"..."}),{workflow:a,name:e.name}}catch(e){if(e instanceof d)throw console.error("Plan compilation failed",{code:e.code,message:e.message,stepType:e.step?.type,orgId:t.orgId.slice(0,8)+"..."}),e;throw console.error("Unexpected compilation error",{error:e instanceof Error?e.message:"Unknown error",orgId:t.orgId.slice(0,8)+"..."}),new d("COMPILATION_ERROR",`Failed to compile plan: ${e instanceof Error?e.message:"Unknown error"}`)}}class R extends Error{constructor(e,t,r){super(t),this.status=e,this.response=r,this.name="N8nError"}}class I{constructor(e){this.apiBasePath=null,this.baseURL=e.baseURL.replace(/\/$/,""),this.apiKey=e.apiKey}async request(e,t,r){this.apiBasePath||await this.detectApiBasePath();let s=`${this.baseURL}${this.apiBasePath}${t}`,o={"X-N8N-API-KEY":this.apiKey,"Content-Type":"application/json"};console.log(`N8n API request: ${e} ${t}`,{url:s.replace(this.apiKey,"[REDACTED]"),hasBody:!!r,bodySize:r?JSON.stringify(r).length:0});try{let n;let a=await fetch(s,{method:e,headers:o,body:r?JSON.stringify(r):void 0}),i=await a.text();try{n=i?JSON.parse(i):null}catch{n={raw:i}}if(!a.ok)throw console.error("N8n API error",{status:a.status,statusText:a.statusText,url:s.replace(this.apiKey,"[REDACTED]"),response:n}),new R(a.status,`N8n API error (${a.status}): ${n?.message||a.statusText}`,n);return console.log(`N8n API response: ${e} ${t}`,{status:a.status,hasData:!!n,dataSize:i.length}),n}catch(e){if(e instanceof R)throw e;throw console.error("N8n API request failed",{error:e instanceof Error?e.message:"Unknown error",url:s.replace(this.apiKey,"[REDACTED]")}),new R(0,`N8n API request failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async detectApiBasePath(){for(let e of["/api/v1","/rest"])try{this.apiBasePath=e,await this.getVersion(),console.log(`N8n API base path detected: ${e}`);return}catch(t){console.log(`N8n API path ${e} failed, trying next...`);continue}throw new R(0,"Could not detect N8n API base path. Tried /api/v1 and /rest. Check your N8n installation and API configuration.")}async getVersion(){return this.request("GET","/")}async listWorkflows(){return(await this.request("GET","/workflows")).data||[]}async getWorkflow(e){return this.request("GET",`/workflows/${e}`)}async createWorkflow(e){return this.request("POST","/workflows",e)}async updateWorkflow(e,t){return this.request("PUT",`/workflows/${e}`,t)}async activateWorkflow(e,t){return this.request("PATCH",`/workflows/${e}`,{active:t})}async deleteWorkflow(e){await this.request("DELETE",`/workflows/${e}`)}async upsertByName(e,t){try{let r;let s=(await this.listWorkflows()).find(t=>t.name===e),o={name:t.name||e,nodes:t.nodes,connections:t.connections,active:!1,settings:{timezone:"America/New_York",saveDataErrorExecution:"all",saveDataSuccessExecution:"all",saveManualExecutions:!0},tags:["arizu-generated"]},n=!1;s?(console.log(`Updating existing workflow: ${e} (${s.id})`),r=await this.updateWorkflow(s.id,o)):(console.log(`Creating new workflow: ${e}`),r=await this.createWorkflow(o),n=!0);let a=this.extractWebhookUrl(r);return{workflowId:r.id,isNew:n,webhookUrl:a}}catch(t){if(console.error("Failed to upsert workflow",{name:e,error:t instanceof Error?t.message:"Unknown error"}),t instanceof R)throw t;throw new R(0,`Failed to upsert workflow "${e}": ${t instanceof Error?t.message:"Unknown error"}`)}}extractWebhookUrl(e){try{let t=e.nodes?.find(e=>"n8n-nodes-base.webhook"===e.type&&e.webhookId);if(t&&t.parameters?.path){let e=t.parameters.path,r=this.baseURL.replace(/\/api.*$/,"");return`${r}/webhook${e}`}return}catch(e){console.warn("Failed to extract webhook URL",{error:e instanceof Error?e.message:"Unknown error"});return}}async getWorkflowByName(e){try{return(await this.listWorkflows()).find(t=>t.name===e)||null}catch(t){return console.error("Failed to get workflow by name",{name:e,error:t instanceof Error?t.message:"Unknown error"}),null}}async healthCheck(){try{return await this.getVersion(),!0}catch(e){return console.error("N8n health check failed",{baseURL:this.baseURL,error:e instanceof Error?e.message:"Unknown error"}),!1}}}var N=r(17081);let _=c.Ry({plan:c._4(),workflowName:c.Z_().min(1).max(100)});async function b(e){try{var t;let r,s;let{userId:o,orgId:n}=(0,l.I8)();if(!o||!n)return i.NextResponse.json({ok:!1,error:{code:"AUTHENTICATION_REQUIRED",message:"Authentication required"}},{status:401});let a=await e.json(),c=_.safeParse(a);if(!c.success)return i.NextResponse.json({ok:!1,error:{code:"INVALID_REQUEST",message:"Invalid request format",details:{issues:c.error.issues.map(e=>({field:e.path.join("."),message:e.message}))}}},{status:400});let{plan:p,workflowName:h}=c.data;console.log("Deployment request",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,planType:typeof p});let g=await (0,u.us)(p,{orgId:n});if(!g.valid)return console.warn("Plan validation failed during deploy",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,issues:g.issues}),i.NextResponse.json({ok:!1,error:(t=g.issues,{code:"PLAN_VALIDATION_FAILED",message:"Plan validation failed",details:{issues:t,suggestion:"Fix the validation issues and try again"}})},{status:422});let m=await (0,N.S0)(n);if(m.workflowsCount>=m.workflowsLimit)return console.warn("Workflow limit exceeded during deploy",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,current:m.workflowsCount,limit:m.workflowsLimit}),i.NextResponse.json({ok:!1,error:{code:"PLAN_LIMIT_EXCEEDED",message:"Workflow limit exceeded for your plan",details:{suggestion:"Upgrade your plan or delete existing workflows to continue"}}},{status:403});try{r=(await k(p,{orgId:n})).workflow}catch(e){if(console.error("Plan compilation failed during deploy",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,error:e instanceof Error?e.message:"Unknown error"}),e instanceof d)return i.NextResponse.json({ok:!1,error:{code:e.code,message:e.message,details:{stepType:e.step?.type,suggestion:"Check your plan structure and step types"}}},{status:422});return i.NextResponse.json({ok:!1,error:{code:"COMPILATION_ERROR",message:"Failed to compile plan to workflow",details:{error:e instanceof Error?e.message:"Unknown error",suggestion:"Check your plan structure and try again"}}},{status:500})}try{let e=function(){let e=process.env.N8N_URL,t=process.env.N8N_API_KEY;if(!e)throw Error("N8N_URL environment variable is required");if(!t)throw Error("N8N_API_KEY environment variable is required");return new I({baseURL:e,apiKey:t})}();if(!await e.healthCheck())throw new R(0,"N8n instance is not reachable");s=await e.upsertByName(h,r),await e.activateWorkflow(s.workflowId,!0),console.log("Workflow deployed successfully",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,workflowId:s.workflowId,isNew:s.isNew,hasWebhook:!!s.webhookUrl})}catch(e){if(console.error("N8n deployment failed",{userId:o.slice(0,8)+"...",orgId:n.slice(0,8)+"...",workflowName:h,error:e instanceof Error?e.message:"Unknown error"}),e instanceof R)return i.NextResponse.json({ok:!1,error:function(e){let t={code:"N8N_API_ERROR",message:`N8n deployment failed: ${e.message}`,details:{status:e.status,suggestion:"Check your N8n instance configuration and try again"}};return 401===e.status?{...t,code:"N8N_UNAUTHORIZED",message:"N8n API authentication failed",details:{...t.details,suggestion:"Check your N8N_API_KEY configuration"}}:404===e.status?{...t,code:"N8N_NOT_FOUND",message:"N8n API endpoint not found",details:{...t.details,suggestion:"Check your N8N_URL configuration and ensure n8n is running"}}:e.status>=500?{...t,code:"N8N_SERVER_ERROR",message:"N8n server error",details:{...t.details,suggestion:"Check n8n server logs and try again"}}:t}(e)},{status:e.status>=400&&e.status<500?e.status:500});return i.NextResponse.json({ok:!1,error:{code:"DEPLOYMENT_ERROR",message:"Failed to deploy workflow to n8n",details:{error:e instanceof Error?e.message:"Unknown error",suggestion:"Check n8n configuration and try again"}}},{status:500})}return i.NextResponse.json({ok:!0,workflowId:s.workflowId,workflowName:h,webhookUrl:s.webhookUrl,isNew:s.isNew,message:s.isNew?"Workflow created and activated":"Workflow updated and activated"})}catch(e){return console.error("Deploy API error",{error:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),i.NextResponse.json({ok:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error",details:{suggestion:"Please try again in a moment. If the problem persists, contact support."}}},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/deploy/route",pathname:"/api/deploy",filename:"route",bundlePath:"app/api/deploy/route"},resolvedPagePath:"/Users/ediyaffe/Documents/GitHub/Arizu/app/api/deploy/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:T,staticGenerationAsyncStorage:P,serverHooks:A}=v,$="/api/deploy/route";function S(){return(0,a.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:P})}},9487:(e,t,r)=>{r.d(t,{db:()=>o});var s=r(53524);let o=globalThis.prisma??new s.PrismaClient({log:["query"]})},70907:(e,t,r)=>{r.d(t,{NH:()=>u});var s=r(19619),o=r.n(s),n=r(28586),a=r.n(n);let i={type:"object",properties:{field:{type:"string"},op:{type:"string",enum:["contains","equals","gt","lt","regex"]},value:{}},required:["field","op","value"],additionalProperties:!1},l=new(o())({allErrors:!0,verbose:!0,strict:!0,removeAdditional:!1});a()(l),l.addSchema({$id:"stepSchema",oneOf:[{type:"object",properties:{type:{type:"string",const:"trigger.http"},path:{type:"string"},secretHmac:{type:"boolean"}},required:["type","path","secretHmac"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"filter"},when:i},required:["type","when"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"action.slack.postMessage"},channel:{type:"string"},text:{type:"string"}},required:["type","channel","text"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"action.http.request"},method:{type:"string",enum:["GET","POST","PUT","DELETE"]},url:{type:"string"},headers:{type:"object",nullable:!0,additionalProperties:!0},body:{type:"object",nullable:!0,additionalProperties:!0}},required:["type","method","url"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"custom.action"},actionSlug:{type:"string"},input:{type:"object",nullable:!0,additionalProperties:!0}},required:["type","actionSlug"],additionalProperties:!1},{type:"object",properties:{type:{type:"string",const:"branch"},cases:{type:"array",items:{type:"object",properties:{when:i,steps:{type:"array",items:{$ref:"stepSchema"}}},required:["when","steps"],additionalProperties:!1},minItems:1},else:{type:"array",items:{$ref:"stepSchema"},nullable:!0}},required:["type","cases"],additionalProperties:!1}]});let c=l.compile({type:"object",properties:{version:{type:"string",const:"1"},name:{type:"string",minLength:1,maxLength:100},steps:{type:"array",items:{$ref:"stepSchema"},minItems:1,maxItems:50}},required:["version","name","steps"],additionalProperties:!1});function u(e){return c(e)?{valid:!0,errors:[],data:e}:{valid:!1,errors:c.errors?.map(e=>{let t=e.instancePath||"root",r=e.message||"validation failed";if("required"===e.keyword){let r=e.params?.missingProperty;return`Missing required property "${r}" at ${t}`}if("enum"===e.keyword){let r=e.params?.allowedValues;return`Invalid value at ${t}. Must be one of: ${r?.join(", ")}`}if("const"===e.keyword){let r=e.params?.allowedValue;return`Invalid value at ${t}. Must be: ${r}`}if("minItems"===e.keyword){let r=e.params?.limit;return`Array at ${t} must have at least ${r} items`}if("maxItems"===e.keyword){let r=e.params?.limit;return`Array at ${t} must have no more than ${r} items`}if("minLength"===e.keyword){let r=e.params?.limit;return`String at ${t} must be at least ${r} characters long`}if("maxLength"===e.keyword){let r=e.params?.limit;return`String at ${t} must be no more than ${r} characters long`}return"oneOf"===e.keyword?`Invalid step type at ${t}. Must be one of: trigger.http, filter, branch, action.slack.postMessage, action.http.request, custom.action`:`${r} at ${t}`})||["Unknown validation error"]}}},93953:(e,t,r)=>{r.d(t,{MD:()=>l,mn:()=>c,us:()=>i});var s=r(70907);async function o(e,t){return console.log(`TODO: Resolve action slug "${e}" for org ${t.slice(0,8)}...`),!1}function n(e,t){let r=`steps[${e}]`;return t?`${r}.${t}`:r}async function a(e,t,r,s){let i=[],l=s?`${s}.steps[${t}]`:n(t);if("custom.action"!==e.type||await o(e.actionSlug,r)||i.push({path:`${l}.actionSlug`,code:"UNKNOWN_ACTION_SLUG",message:`Custom action "${e.actionSlug}" is not available for your organization. Check the spelling or contact support to add this action.`}),"action.http.request"===e.type&&!function(e){try{let t=new URL(e).hostname.toLowerCase();return["api.slack.com","hooks.slack.com","api.github.com","api.salesforce.com","graph.microsoft.com","api.hubspot.com","api.stripe.com","api.zapier.com","jsonplaceholder.typicode.com"].some(e=>t===e||t.endsWith(`.${e}`))}catch{return!1}}(e.url)&&i.push({path:`${l}.url`,code:"FORBIDDEN_HOST",message:`HTTP requests to ${function(e){try{let t=new URL(e);return`${t.protocol}//${t.hostname}${t.pathname?"/...":""}`}catch{return"[INVALID_URL]"}}(e.url)} are not allowed. Contact support to allowlist this host.`}),"branch"===e.type){for(let t=0;t<e.cases.length;t++){let s=e.cases[t],o=`${l}.cases[${t}]`;if(s.steps&&0!==s.steps.length)for(let e=0;e<s.steps.length;e++){let t=await a(s.steps[e],e,r,o);i.push(...t)}else i.push({path:`${o}.steps`,code:"EMPTY_BRANCH_CASE",message:"Branch cases must contain at least one step. Add an action or remove this case."})}if(e.else){if(0===e.else.length)i.push({path:`${l}.else`,code:"EMPTY_BRANCH_ELSE",message:"Branch else clause cannot be empty. Add steps or remove the else clause."});else for(let t=0;t<e.else.length;t++){let s=await a(e.else[t],t,r,`${l}.else`);i.push(...s)}}}return i}async function i(e,t){let r=[],o=(0,s.NH)(e);if(!o.valid)return{valid:!1,issues:o.errors.map(e=>({path:"schema",code:"SCHEMA_VALIDATION_FAILED",message:e}))};let i=o.data;try{0===i.steps.length?r.push({path:"steps",code:"NO_STEPS",message:"Plan must contain at least one step."}):i.steps[0].type.startsWith("trigger.")||r.push({path:"steps[0].type",code:"MUST_START_WITH_TRIGGER",message:"Plan must start with a trigger step (e.g., trigger.http). Add a trigger as the first step."});for(let e=0;e<i.steps.length;e++){let s=await a(i.steps[e],e,t.orgId);r.push(...s)}i.steps.filter(e=>e.type.startsWith("trigger.")).length>1&&r.push({path:"steps",code:"MULTIPLE_TRIGGERS",message:"Plan can only have one trigger step. Remove extra trigger steps or create separate plans."}),i.steps.forEach((e,t)=>{"action.slack.postMessage"!==e.type||e.channel.startsWith("#")||e.channel.startsWith("@")||r.push({path:n(t,"channel"),code:"INVALID_SLACK_CHANNEL",message:`Slack channel must start with # for channels or @ for users. Got: "${e.channel}"`})}),i.steps.forEach((e,t)=>{"trigger.http"===e.type&&(e.path.startsWith("/")||r.push({path:n(t,"path"),code:"INVALID_WEBHOOK_PATH",message:`Webhook path must start with /. Got: "${e.path}"`}),(e.path.includes(" ")||e.path.includes("?"))&&r.push({path:n(t,"path"),code:"INVALID_WEBHOOK_PATH_FORMAT",message:`Webhook path cannot contain spaces or query parameters. Got: "${e.path}"`}))})}catch(e){console.error("Error during plan validation:",{orgId:t.orgId.slice(0,8)+"...",error:e instanceof Error?e.message:"Unknown error"}),r.push({path:"validation",code:"VALIDATION_ERROR",message:"An error occurred during plan validation. Please try again."})}return{valid:0===r.length,issues:r}}function l(e){if(e.valid)return"Plan is valid and ready to use.";let t=e.issues.length,r=e.issues.filter(e=>"SCHEMA_VALIDATION_FAILED"===e.code||"MUST_START_WITH_TRIGGER"===e.code).length;return r>0?`Plan has ${t} issue${t>1?"s":""} including ${r} critical error${r>1?"s":""}. Fix critical errors first.`:`Plan has ${t} issue${t>1?"s":""} that should be addressed before deployment.`}function c(e){let t=e.filter(e=>"SCHEMA_VALIDATION_FAILED"===e.code||"MUST_START_WITH_TRIGGER"===e.code||"NO_STEPS"===e.code||"EMPTY_BRANCH_CASE"===e.code),r=e.filter(e=>"UNKNOWN_ACTION_SLUG"===e.code||"FORBIDDEN_HOST"===e.code||"MULTIPLE_TRIGGERS"===e.code),s=e.filter(e=>!t.includes(e)&&!r.includes(e));return{critical:t,warning:r,info:s}}},17081:(e,t,r)=>{r.d(t,{Nv:()=>a,QJ:()=>i,S0:()=>c,fE:()=>d,qL:()=>h});var s=r(9487);let o={FREE:{features:["basic_automations","email_notifications","community_support"]},PRO:{features:["basic_automations","advanced_triggers","webhooks","email_notifications","slack_integration","priority_support","analytics_basic"]},TEAM:{features:["basic_automations","advanced_triggers","webhooks","email_notifications","slack_integration","team_collaboration","user_management","priority_support","analytics_advanced","custom_branding"]},ENTERPRISE:{features:["basic_automations","advanced_triggers","webhooks","email_notifications","slack_integration","team_collaboration","user_management","code_steps","custom_integrations","sso","audit_logs","dedicated_support","analytics_enterprise","custom_branding","sla_guarantee"]}},n={FREE:{monthlyRuns:100,workflows:3,actionsAllowed:5,codeSteps:!1},PRO:{monthlyRuns:1e4,workflows:50,actionsAllowed:20,codeSteps:!1},TEAM:{monthlyRuns:5e4,workflows:200,actionsAllowed:50,codeSteps:!0},ENTERPRISE:{monthlyRuns:5e5,workflows:1e3,actionsAllowed:100,codeSteps:!0}},a={FREE:{key:"FREE",name:"Free",description:"Perfect for getting started with automation",price:{monthly:0,yearly:0},features:o.FREE.features,limits:n.FREE},PRO:{key:"PRO",name:"Pro",description:"For individuals and small teams",price:{monthly:29,yearly:290},features:o.PRO.features,limits:n.PRO,popular:!0},TEAM:{key:"TEAM",name:"Team",description:"For growing teams and businesses",price:{monthly:99,yearly:990},features:o.TEAM.features,limits:n.TEAM},ENTERPRISE:{key:"ENTERPRISE",name:"Enterprise",description:"For large organizations with advanced needs",price:{monthly:299,yearly:2990},features:o.ENTERPRISE.features,limits:n.ENTERPRISE}};async function i(e){try{let t=await s.db.organization.findUnique({where:{clerkId:e},select:{planType:!0}});if(!t)throw Error(`Organization not found: ${e}`);return function(e){switch(e){case"FREE":default:return"FREE";case"PRO":case"STARTER":return"PRO";case"ENTERPRISE":return"ENTERPRISE"}}(t.planType)}catch(t){return console.error("Error getting plan for organization:",{orgId:e.slice(0,8)+"...",error:t instanceof Error?t.message:"Unknown error"}),"FREE"}}function l(){let e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}async function c(e){try{let[t,r,s]=await Promise.all([i(e),u(e),p(e)]),o=n[t];return{monthlyRunsUsed:r.monthlyRunsUsed,monthlyRunsLimit:o.monthlyRuns,workflowsCount:s,workflowsLimit:o.workflows,actionsLimit:o.actionsAllowed,hasCodeSteps:o.codeSteps}}catch(t){return console.error("Error getting current usage:",{orgId:e.slice(0,8)+"...",error:t instanceof Error?t.message:"Unknown error"}),{monthlyRunsUsed:0,monthlyRunsLimit:0,workflowsCount:0,workflowsLimit:0,actionsLimit:0,hasCodeSteps:!1}}}async function u(e){let t=l();return await s.db.usageCounter.upsert({where:{organizationId_periodKey:{organizationId:e,periodKey:t}},update:{},create:{organizationId:e,periodKey:t,monthlyRunsUsed:0,monthlyRunsLimit:0,workflowsCount:0}})}async function p(e){return await s.db.automation.count({where:{organizationId:e,isActive:!0}})}async function d(e,t=1){let r=l();await s.db.usageCounter.upsert({where:{organizationId_periodKey:{organizationId:e,periodKey:r}},update:{monthlyRunsUsed:{increment:t}},create:{organizationId:e,periodKey:r,monthlyRunsUsed:t,monthlyRunsLimit:0,workflowsCount:0}})}function h(e){let t=["FREE","PRO","TEAM","ENTERPRISE"],r=t.indexOf(e);return -1===r||r===t.length-1?null:t[r+1]}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,14,471,696,586],()=>r(49352));module.exports=s})();